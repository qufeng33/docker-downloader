# GEMINI.md - AI 助手指南

本文件为 AI 助手提供了一份全面的指南，旨在帮助其理解 Docker Downloader 项目并为其做出贡献。它概述了项目的架构、开发实践、编码约定和沟通规范。

## 1. 项目概述

**产品**：Docker Downloader 是一个使用 Electron、NestJS 和 Vue 3 构建的跨平台桌面应用程序。它允许用户（尤其是在企业或离线环境中的用户）从公共和私有仓库下载 Docker 镜像，并将其保存为 `.tar.gz` 文件，以便日后通过 `docker load` 使用。

**核心功能**：
- **仓库管理**：支持 Docker Hub 和私有仓库。
- **镜像发现**：搜索镜像并浏览其标签和支持的 CPU 架构。
- **并发下载**：并行下载镜像层以提高速度。
- **下载管理**：一个具有暂停、恢复和取消功能的队列系统。
- **安全配置**：安全地管理下载设置、主题和凭证。

**目标受众**：处于离线或网络受限环境中的企业开发者和 DevOps 团队。

## 2. 技术架构

该应用程序遵循现代化的模块化架构，以确保稳定性、可伸缩性和可维护性。

### 2.1. 主进程 (后端) - NestJS

主进程是一个健壮的 NestJS 应用程序，负责所有业务逻辑。

- **模块化**：后端被划分为多个功能模块（例如 `Registry`、`Download`、`Auth`、`Config`）。每个模块都有单一职责，并包含自己的控制器、服务和 DTO。
- **依赖注入 (DI)**：服务在 NestJS 的 DI 容器中注册，并通过构造函数注入。这促进了解耦和可测试性。避免循环依赖，仅在绝对必要时使用 `forwardRef`。
- **服务层**：包含所有业务逻辑。控制器应保持轻量，并将复杂任务委托给服务。
- **事件驱动**：使用 `@nestjs/event-emitter` 处理异步操作，如下载进度更新。事件名称遵循 `模块.动作` 的约定（例如 `download.progress`）。
- **配置**：由 `@nestjs/config` 管理，从环境变量或配置文件加载。

### 2.2. 渲染进程 (前端) - Vue 3

用户界面是一个 Vue 3 应用程序。

- **组件库**：使用 **Element Plus** 作为 UI 组件。遵循其设计语言并一致地使用其组件。
- **状态管理**：（详细信息应从 `src/renderer/src/stores/` 中推断，如果存在）。
- **API 交互**：通过类型安全的 IPC 桥与主进程通信。

### 2.3. IPC (进程间通信)

主进程和渲染进程之间的类型安全通信至关重要。

- **框架**：使用 **`@doubleshot/nest-electron`**。
- **装饰器**：
    - `@Controller('namespace')`：为一组 IPC 处理器定义命名空间。
    - `@IpcHandle('kebab-case-action')`：用于请求-响应方法（例如，获取数据）。
    - `@IpcOn('kebab-case-action')`：用于基于事件的单向通信。
- **类型安全**：所有 IPC 方法的负载都使用 DTO，以确保类型安全。`preload` 脚本向渲染器暴露具有完整类型定义的 IPC API。**绝不使用 `any` 类型。**

### 2.4. 错误处理

- **自定义异常**：使用自定义异常类来区分业务逻辑错误和系统错误。
- **IPC 传播**：来自主进程的错误必须被正确捕获并传播到渲染进程，以显示给用户。
- **用户友好的消息**：向用户显示的错误消息必须清晰、简洁，并且不应暴露敏感的系统细节。

## 3. 开发工作流

### 3.1. 环境

- **Node.js**：>= 22.0.0
- **pnpm**：>= 10.0.0
- **Python**：>= 3.8 (用于 `node-gyp`)
- **IDE**：VS Code 或 WebStorm

### 3.2. 命令

- `pnpm install`：安装依赖。
- `pnpm dev`：在开发模式下运行，支持热重载。
- `pnpm lint`：运行 ESLint 检查。
- `pnpm typecheck`：运行 TypeScript 编译器检查。
- `pnpm build`：构建生产版本的应用程序。

### 3.3. Git 工作流

- **分支**：使用 Git Flow (`main`, `develop`, `feature/*`, `hotfix/*`)。
- **提交信息**：遵循约定式提交规范。描述部分使用中文。
    - `feat`：新功能。
    - `fix`：错误修复。
    - `docs`：文档变更。
    - `refactor`：不改变功能的代码重构。
    - `style`：代码风格更改（格式化）。
    - `test`：添加或改进测试。

### 3.4. 测试

- **框架**：Jest。
- **单元测试**：每个服务类都必须有相应的单元测试。目标覆盖率 >80%。
- **集成测试**：验证完整的 IPC 通信流程，模拟外部依赖（如网络请求）。

## 4. 代码风格与质量

- **语言**：TypeScript。
- **Linter**：ESLint。所有代码在提交前必须通过 `pnpm run lint` 且无错误。
- **格式化工具**：Prettier。
- **命名**：
    - 变量/函数：`camelCase` (英文)。
    - 类/接口：`PascalCase` (英文)。
    - IPC 方法：`kebab-case` (用于 handle 名称)。
- **注释**：使用中文解释代码*为什么*这样写，而不是*做什么*。

## 5. UI/UX 指南

- **组件库**：**Element Plus**。一致地使用其组件和设计原则。
- **响应式**：布局必须是响应式的，并能适应不同的窗口大小。侧边栏应可折叠。
- **主题**：支持浅色、深色和系统默认主题。主题切换必须是实时的。
- **用户反馈**：
    - 为所有异步操作提供清晰的加载状态。
    - 显示用户友好的错误消息，并提供恢复建议。
    - 对成功的操作使用通知/提示。
- **性能**：对长列表（>100 项）使用虚拟滚动以确保流畅的性能。

## 6. 安全性

- **凭证存储**：使用 `keytar` 将用户凭证安全地存储在操作系统的钥匙串/凭证管理器中。
- **输入验证**：
    - 严格根据白名单验证所有用户输入（例如，镜像名称、URL）。
    - 防止路径遍历和命令注入攻击。
- **网络**：
    - 所有通信都使用 HTTPS。
    - 默认必须启用证书验证。
- **数据完整性**：验证所有下载文件的 SHA256 校验和。
- **Electron 安全**：
    - 启用沙箱模式。
    - 启用上下文隔离。
    - 在渲染进程中禁用 Node.js 集成。
- **日志记录**：**绝不**记录敏感信息（密码、令牌、密钥）。在记录前过滤和清理数据。

## 7. 日志记录

- **库**：`electron-log`。
- **配置**：主进程和渲染进程使用统一的配置。渲染进程的日志被转发到主进程。
- **级别**：
    - `ERROR`：系统错误、异常。
    - `WARN`：潜在问题、性能警告。
    - `INFO`：关键业务流程的里程碑（例如，下载开始）。
    - `DEBUG`：用于调试的详细信息。
- **格式**：日志必须是结构化的（JSON），并包含时间戳、级别、进程类型、模块名称和消息。
- **文件管理**：日志按日期和大小（最大 10MB）进行轮转。日志保留 30 天。

## 8. 沟通

- **主要语言**：**中文**。所有面向用户的文本、文档和代码注释都应使用中文。
- **技术术语**：可接受使用英文技术术语。
- **语气**：专业、友好、清晰。